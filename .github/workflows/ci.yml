name: ci

on:
  push:
  pull_request:

jobs:
  dart:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - name: Install dependencies
        run: dart pub get
      - name: Format
        run: dart format --output=none --set-exit-if-changed lib test tool example bin
      - name: Analyze
        run: dart analyze lib test tool example bin
      - name: Test
        run: dart test
      - name: Contract runner
        run: dart run tool/contract.dart
      - name: Build artifacts
        run: dart run tool/build.dart

  contract-matrix:
    runs-on: ubuntu-latest
    needs: dart
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - uses: actions/setup-node@v4
        with:
          node-version: latest
      - uses: oven-sh/setup-bun@v2
      - uses: denoland/setup-deno@v1
      - name: Install dependencies
        run: dart pub get
      - name: Runtime contract matrix
        run: dart run tool/contract_matrix.dart

  edge-contract:
    runs-on: ubuntu-latest
    needs: dart
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - uses: actions/setup-node@v4
        with:
          node-version: latest
      - run: dart pub get
      - run: dart run tool/build.dart
      - name: Edge adapters contract
        run: |
          node --input-type=module -e "
          import cf from './dist/edge/cloudflare/index.mjs';
          import vercel from './dist/edge/vercel/index.mjs';
          import netlify from './dist/edge/netlify/index.mjs';
          const req = new Request('https://example.com/edge');

          const cfRes = await cf.fetch(req, { TOKEN: 'cf' }, { waitUntil() {} });
          const cfBody = await cfRes.json();

          const veRes = await vercel(req, { env: { TOKEN: 've' }, waitUntil() {} });
          const veBody = await veRes.json();

          const neRes = await netlify(req, { env: { TOKEN: 'ne' }, waitUntil() {} });
          const neBody = await neRes.json();

          const valid =
            cfBody.ok === true &&
            veBody.ok === true &&
            neBody.ok === true &&
            cfBody.runtime === 'cloudflare' &&
            veBody.runtime === 'vercel' &&
            neBody.runtime === 'netlify';

          if (!valid) {
            process.exit(1);
          }
          "
