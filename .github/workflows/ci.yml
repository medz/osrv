name: ci

on:
  push:
  pull_request:

jobs:
  dart:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - name: Install dependencies
        run: dart pub get
      - name: Format
        run: dart format --output=none --set-exit-if-changed .
      - name: Analyze
        run: dart analyze
      - name: Test
        run: dart test
      - name: Contract runner
        run: dart run tool/contract.dart
      - name: Benchmark gate
        run: dart run tool/bench.dart --requests=120 --max-overhead=0.05
      - name: Build artifacts
        run: dart run tool/build.dart

  node-smoke:
    runs-on: ubuntu-latest
    needs: dart
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - uses: actions/setup-node@v4
        with:
          node-version: latest
      - run: dart pub get
      - run: dart run tool/build.dart
      - name: Node adapter scaffold smoke
        run: |
          node --input-type=module -e "
          import { serve } from './dist/js/node/index.mjs';
          try {
            serve();
            process.exit(1);
          } catch (e) {
            if (!String(e).includes('scaffold')) process.exit(1);
          }
          "

  bun-smoke:
    runs-on: ubuntu-latest
    needs: dart
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - uses: oven-sh/setup-bun@v2
      - run: dart pub get
      - run: dart run tool/build.dart
      - name: Bun adapter scaffold smoke
        run: |
          bun --eval "
          import { serve } from './dist/js/bun/index.mjs';
          try {
            serve();
            process.exit(1);
          } catch (e) {
            if (!String(e).includes('scaffold')) process.exit(1);
          }
          "

  deno-smoke:
    runs-on: ubuntu-latest
    needs: dart
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - uses: denoland/setup-deno@v1
      - run: dart pub get
      - run: dart run tool/build.dart
      - name: Deno adapter scaffold smoke
        run: |
          deno eval "
          import { serve } from './dist/js/deno/index.mjs';
          try {
            serve();
            Deno.exit(1);
          } catch (e) {
            if (!String(e).includes('scaffold')) Deno.exit(1);
          }
          "

  edge-smoke:
    runs-on: ubuntu-latest
    needs: dart
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - uses: actions/setup-node@v4
        with:
          node-version: latest
      - run: dart pub get
      - run: dart run tool/build.dart
      - name: Edge adapters scaffold smoke
        run: |
          node --input-type=module -e "
          import cf from './dist/edge/cloudflare/index.mjs';
          import vercel from './dist/edge/vercel/index.mjs';
          import netlify from './dist/edge/netlify/index.mjs';
          const req = new Request('https://example.com/');
          const cfRes = await cf.fetch(req, {}, { waitUntil() {} });
          const veRes = await vercel(req, { env: {}, waitUntil() {} });
          const neRes = await netlify(req, { env: {}, waitUntil() {} });
          if (cfRes.status !== 501 || veRes.status !== 501 || neRes.status !== 501) {
            process.exit(1);
          }
          "
